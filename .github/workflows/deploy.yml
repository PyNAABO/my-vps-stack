name: Deploy to VPS

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_IP }}
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /root/my-vps-stack

            # 1. Update Code (force reset to handle local changes)
            git fetch origin main
            git reset --hard origin/main

            # 2. Setup Directories & Env
            mkdir -p config/tunnel config/fb config/qbit
            echo "" > .env

            # 3. Auto-generate docker-compose.yml from apps/*/docker-compose.yml
            echo "# Auto-generated - DO NOT EDIT" > docker-compose.yml
            echo "# Add/remove apps by adding/removing folders in apps/" >> docker-compose.yml
            echo "" >> docker-compose.yml
            echo "include:" >> docker-compose.yml
            for compose_file in apps/*/docker-compose.yml; do
              if [ -f "$compose_file" ]; then
                echo "  - $compose_file" >> docker-compose.yml
                echo "  âœ“ Included: $compose_file"
              fi
            done

            # 4. Generate Tunnel Config from apps/*/ingress.yml
            if [ -n "${{ secrets.DOMAIN }}" ] && [ -n "${{ secrets.TUNNEL_CREDENTIALS }}" ]; then
              echo "âœ… Generating Tunnel Config..."
              echo '${{ secrets.TUNNEL_CREDENTIALS }}' > config/tunnel/cert.json
              
              # Build tunnel config header
              echo "tunnel: ${{ secrets.TUNNEL_ID }}" > config/tunnel/config.yml
              echo "credentials-file: /etc/cloudflared/cert.json" >> config/tunnel/config.yml
              echo "ingress:" >> config/tunnel/config.yml
              
              # Dynamically add ingress rules from each app's ingress.yml
              for ingress_file in apps/*/ingress.yml; do
                if [ -f "$ingress_file" ]; then
                  hostname=$(grep "^hostname:" "$ingress_file" | cut -d' ' -f2)
                  service=$(grep "^service:" "$ingress_file" | cut -d' ' -f2)
                  echo "  - hostname: ${hostname}.${{ secrets.DOMAIN }}" >> config/tunnel/config.yml
                  echo "    service: ${service}" >> config/tunnel/config.yml
                  echo "  âœ“ Added route: ${hostname} -> ${service}"
                fi
              done
              
              # Add catch-all 404
              echo "  - service: http_status:404" >> config/tunnel/config.yml

              echo "DOMAIN_NAME=${{ secrets.DOMAIN }}" >> .env
            else
              echo "âš ï¸ Fallback Mode"
              echo "DOMAIN_NAME=localhost" >> .env
            fi

            # 5. Inject WhatsApp Bot Config
            echo "ALLOWED_GROUP_ID=${{ secrets.ALLOWED_GROUP_ID }}" >> .env

            # 6. Run init scripts for each app (first-time setup)
            for init_script in apps/*/init.sh; do
              if [ -f "$init_script" ]; then
                echo "ðŸ”§ Running $(dirname $init_script)/init.sh"
                bash "$init_script"
              fi
            done

            # 7. Deployment
            sysctl -w net.core.rmem_max=2500000 || true
            docker compose up -d --build --remove-orphans
            docker image prune -f
            echo "âœ… Deployment Completed!"
