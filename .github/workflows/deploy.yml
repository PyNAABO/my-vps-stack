name: Deploy to Home Lab

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Setup the Tunnel Connection (COPIED FROM YOUR WORKING BASIC SCRIPT)
      - name: Configure SSH with Cloudflare Auth
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          # Install cloudflared
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O /usr/local/bin/cloudflared
          chmod +x /usr/local/bin/cloudflared

          # Configure SSH to use the Tunnel + Service Token
          # WE REMOVED THE MISSING SECRETS AND HARDCODED THE WORKING VALUES HERE:
          echo "Host lap801" >> ~/.ssh/config
          echo "  HostName lap801.nabhan.co.in" >> ~/.ssh/config
          echo "  User naabo" >> ~/.ssh/config
          echo "  IdentityFile ~/.ssh/id_ed25519" >> ~/.ssh/config
          echo "  ProxyCommand /usr/local/bin/cloudflared access ssh --hostname %h --id ${{ secrets.CF_CLIENT_ID }} --secret ${{ secrets.CF_CLIENT_SECRET }}" >> ~/.ssh/config
          echo "StrictHostKeyChecking no" >> ~/.ssh/config

      # 2. Execute the Deployment Script
      - name: Deploy via SSH
        run: |
          # We pass secrets as environment variables into the SSH session
          # NOTE: We use 'ssh lap801' to match the config above
          ssh lap801 "export TUNNEL_CREDENTIALS='${{ secrets.TUNNEL_CREDENTIALS }}'; \
                      export DOMAIN='${{ secrets.DOMAIN }}'; \
                      export TUNNEL_ID='${{ secrets.TUNNEL_ID }}'; \
                      export TG_BOT_TOKEN='${{ secrets.TG_BOT_TOKEN }}'; \
                      export ALLOWED_GROUP_ID='${{ secrets.ALLOWED_GROUP_ID }}'; \
                      bash -s" << 'EOF'
            
            # --- START OF REMOTE SCRIPT ---
            
            # 0. Cold Start (Auto-clone if missing)
            if [ ! -d "$HOME/my-vps-stack" ]; then
              echo "ðŸš€ Cold Start: Cloning repository..."
              # Assuming public repo or SSH key already on VPS
              git clone https://github.com/${{ github.repository }}.git $HOME/my-vps-stack
            fi
            cd $HOME/my-vps-stack

            # 1. Update Code
            git fetch origin main
            git reset --hard origin/main

            # 2. Setup Directories & Env
            mkdir -p config/tunnel config/fb config/qbit
            : > .env

            # 3. Auto-generate docker-compose.yml
            echo "# Auto-generated - DO NOT EDIT" > docker-compose.yml
            echo "include:" >> docker-compose.yml
            for app_dir in apps/*/; do
              if [ -f "${app_dir}docker-compose.yml" ]; then
                echo "  - ${app_dir}docker-compose.yml" >> docker-compose.yml
                echo "  âœ“ Included: ${app_dir}docker-compose.yml"
              elif [ -f "${app_dir}compose.yaml" ]; then
                echo "  - ${app_dir}compose.yaml" >> docker-compose.yml
                echo "  âœ“ Included: ${app_dir}compose.yaml"
              fi
            done

            # 4. Generate Tunnel Config
            if [ -n "$DOMAIN" ] && [ -n "$TUNNEL_CREDENTIALS" ]; then
              echo "âœ… Generating Tunnel Config..."
              echo "$TUNNEL_CREDENTIALS" > config/tunnel/cert.json
              
              echo "tunnel: $TUNNEL_ID" > config/tunnel/config.yml
              echo "credentials-file: /etc/cloudflared/cert.json" >> config/tunnel/config.yml
              echo "ingress:" >> config/tunnel/config.yml

              # Install yq locally (no sudo needed)
              mkdir -p $HOME/bin
              if [ ! -f "$HOME/bin/yq" ]; then
                wget -qO $HOME/bin/yq https://github.com/mikefarah/yq/releases/download/v4.40.5/yq_linux_amd64 && chmod +x $HOME/bin/yq
              fi
              export PATH=$HOME/bin:$PATH

              for ingress_file in apps/*/ingress.yml; do
                if [ -f "$ingress_file" ]; then
                  hostname=$(yq '.hostname' "$ingress_file")
                  service=$(yq '.service' "$ingress_file")
                  echo "  - hostname: ${hostname}.${DOMAIN}" >> config/tunnel/config.yml
                  echo "    service: ${service}" >> config/tunnel/config.yml
                  echo "  âœ“ Added route: ${hostname} -> ${service}"
                fi
              done
              
              # Catch-all
              echo "  - service: http_status:404" >> config/tunnel/config.yml
              
              echo "DOMAIN_NAME=${DOMAIN}" >> .env
            else
               echo "DOMAIN_NAME=localhost" >> .env
            fi

            # 5. Inject Secrets
            echo "TG_BOT_TOKEN=$TG_BOT_TOKEN" >> .env
            echo "ALLOWED_GROUP_ID=$ALLOWED_GROUP_ID" >> .env

            # 6. Run init scripts
            for init_script in apps/*/init.sh; do
              if [ -f "$init_script" ]; then
                echo "ðŸ”§ Running $init_script"
                bash "$init_script"
              fi
            done

            # 7. Deployment
            # Note: We skip sysctl to avoid sudo password issues in headless mode
            
            docker compose up -d --build --remove-orphans --wait
            docker image prune -f

            # 8. Restart Portainer (Optional - keeps it healthy)
            docker restart portainer || true
            
            echo "âœ… Deployment Completed!"
            
            # --- END OF REMOTE SCRIPT ---
          EOF
