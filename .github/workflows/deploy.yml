name: Deploy to VPS

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_IP }}
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /root/my-vps-stack
            # 1. Update Code
            git pull origin main

            # 2. Setup Directories & Env
            mkdir -p config/tunnel
            echo "" > .env

            # 3. Generate Tunnel Config
            if [ -n "${{ secrets.DOMAIN }}" ] && [ -n "${{ secrets.TUNNEL_CREDENTIALS }}" ]; then
              echo "✅ Local Mode: Generating Tunnel Config..."
              echo '${{ secrets.TUNNEL_CREDENTIALS }}' > config/tunnel/cert.json

              # CRITICAL FIX: The content below must be flush left (no indentation)
              cat <<EOF > config/tunnel/config.yml
            tunnel: ${{ secrets.TUNNEL_ID }}
            credentials-file: /etc/cloudflared/cert.json
            ingress:
              - hostname: docker.${{ secrets.DOMAIN }}
                service: http://portainer:9000
              - hostname: status.${{ secrets.DOMAIN }}
                service: http://uptime-kuma:3001
              - hostname: drive.${{ secrets.DOMAIN }}
                service: http://filebrowser:80
              - hostname: seed.${{ secrets.DOMAIN }}
                service: http://qbittorrent:8080
              - hostname: n8n.${{ secrets.DOMAIN }}
                service: http://n8n:5678
              - service: http_status:404
            EOF

              echo "DOMAIN_NAME=${{ secrets.DOMAIN }}" >> .env
            else
              echo "⚠️ Fallback Mode"
              echo "DOMAIN_NAME=localhost" >> .env
            fi

            # 4. Generate FileBrowser Settings
            mkdir -p config/fb
            cat <<EOF > config/fb/settings.json
            {
              "port": 80,
              "address": "",
              "database": "/database.db",
              "root": "/srv"
            }
            EOF

            # 5. Initialize FileBrowser DB if missing
            if [ ! -s config/fb/filebrowser.db ]; then
              touch config/fb/filebrowser.db
              chmod 666 config/fb/filebrowser.db
              docker run --rm -v $(pwd)/config/fb/filebrowser.db:/database.db -v $(pwd)/config/fb/settings.json:/config/settings.json filebrowser/filebrowser config init
              docker run --rm -v $(pwd)/config/fb/filebrowser.db:/database.db -v $(pwd)/config/fb/settings.json:/config/settings.json filebrowser/filebrowser users add admin adminadmin1234 --perm.admin
            fi

            # 6. Configure qBittorrent
            mkdir -p config/qbit/qBittorrent
            if [ ! -f config/qbit/qBittorrent/qBittorrent.conf ]; then
              cat <<EOF > config/qbit/qBittorrent/qBittorrent.conf
            [LegalNotice]
            Accepted=true
            [Preferences]
            WebUI\Address=*
            WebUI\Port=8080
            EOF
            fi

            # 7. Deployment
            sysctl -w net.core.rmem_max=2500000 || true
            docker compose up -d --build --remove-orphans
            docker image prune -f
            echo "✅ Deployment Completed!"
