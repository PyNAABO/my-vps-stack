name: Deploy to VPS

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_IP }}
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /root/my-vps-stack

            # 1. Update Code (force reset to handle local changes)
            git fetch origin main
            git reset --hard origin/main

            # 2. Setup Directories & Env
            mkdir -p config/tunnel config/fb config/qbit
            : > .env  # Clear .env (safer than echo)

            # 3. Auto-generate docker-compose.yml from apps/*/docker-compose.yml
            echo "# Auto-generated - DO NOT EDIT" > docker-compose.yml
            echo "# Add/remove apps by adding/removing folders in apps/" >> docker-compose.yml
            echo "" >> docker-compose.yml
            echo "include:" >> docker-compose.yml
            for compose_file in apps/*/docker-compose.yml; do
              if [ -f "$compose_file" ]; then
                echo "  - $compose_file" >> docker-compose.yml
                echo "  âœ“ Included: $compose_file"
              fi
            done

            # 4. Generate Tunnel Config from apps/*/ingress.yml
            if [ -n "${{ secrets.DOMAIN }}" ] && [ -n "${{ secrets.TUNNEL_CREDENTIALS }}" ]; then
              echo "âœ… Generating Tunnel Config..."
              echo '${{ secrets.TUNNEL_CREDENTIALS }}' > config/tunnel/cert.json
              
              # Build tunnel config header
              echo "tunnel: ${{ secrets.TUNNEL_ID }}" > config/tunnel/config.yml
              echo "credentials-file: /etc/cloudflared/cert.json" >> config/tunnel/config.yml
              echo "ingress:" >> config/tunnel/config.yml
              
              # Dynamically add ingress rules from each app's ingress.yml
              # Install yq once if not present (with fallback to grep)
              if ! command -v yq &>/dev/null; then
                wget -qO /usr/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 && chmod +x /usr/bin/yq || echo "âš ï¸ yq install failed, using grep fallback"
              fi
              
              for ingress_file in apps/*/ingress.yml; do
                if [ -f "$ingress_file" ]; then
                  if command -v yq &>/dev/null; then
                    hostname=$(yq '.hostname' "$ingress_file")
                    service=$(yq '.service' "$ingress_file")
                  else
                    hostname=$(grep "^hostname:" "$ingress_file" | awk '{print $2}')
                    service=$(grep "^service:" "$ingress_file" | awk '{print $2}')
                  fi
                  echo "  - hostname: ${hostname}.${{ secrets.DOMAIN }}" >> config/tunnel/config.yml
                  echo "    service: ${service}" >> config/tunnel/config.yml
                  echo "  âœ“ Added route: ${hostname} -> ${service}"
                fi
              done
              
              # Add catch-all 404
              echo "  - service: http_status:404" >> config/tunnel/config.yml

              echo "DOMAIN_NAME=${{ secrets.DOMAIN }}" >> .env
              
              # Force tunnel to reload new config
              docker restart my-vps-stack-tunnel 2>/dev/null || true
            else
              echo "âš ï¸ Fallback Mode"
              echo "DOMAIN_NAME=localhost" >> .env
            fi

            # 5. Inject Bot Configs
            echo "TG_BOT_TOKEN=${{ secrets.TG_BOT_TOKEN }}" >> .env
            echo "ALLOWED_GROUP_ID=${{ secrets.ALLOWED_GROUP_ID }}" >> .env

            # 6. Generate Dashboard from ingress.yml files
            mkdir -p config/dashboard
            cat > config/dashboard/index.html << 'DASHBOARD_HTML'
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VPS Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }
    h1 {
      color: #fff;
      font-size: 2rem;
      margin-bottom: 2rem;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1.5rem;
      max-width: 900px;
      width: 100%;
    }
    .tile {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 16px;
      padding: 1.5rem;
      text-align: center;
      text-decoration: none;
      color: #fff;
      transition: all 0.3s ease;
    }
    .tile:hover {
      transform: translateY(-5px);
      background: rgba(255,255,255,0.2);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .tile-icon {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
    }
    .tile-name {
      font-weight: 600;
      font-size: 1.1rem;
    }
    .footer {
      margin-top: 2rem;
      color: rgba(255,255,255,0.5);
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <h1>ðŸš€ VPS Dashboard</h1>
  <div class="grid">
DASHBOARD_HTML

            # Add tiles for each app with ingress
            declare -A icons
            icons[portainer]="ðŸ³"; icons[dozzle]="ðŸ“œ"; icons[filebrowser]="ðŸ“"
            icons[qbittorrent]="â¬‡ï¸"; icons[uptime-kuma]="ðŸ“Š"; icons[dashboard]="ðŸ "
            icons[telegram-bot]="ðŸ¤–"; icons[whatsapp-bot]="ðŸ’¬"
            
            for ingress_file in apps/*/ingress.yml; do
              if [ -f "$ingress_file" ]; then
                app_dir=$(dirname "$ingress_file")
                app_name=$(basename "$app_dir")
                
                # Skip dashboard itself
                [ "$app_name" = "dashboard" ] && continue
                
                if command -v yq &>/dev/null; then
                  hostname=$(yq '.hostname' "$ingress_file")
                else
                  hostname=$(grep "^hostname:" "$ingress_file" | awk '{print $2}')
                fi
                
                icon="${icons[$app_name]:-ðŸ”—}"
                display_name=$(echo "$app_name" | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g')
                
                cat >> config/dashboard/index.html << TILE
    <a href="https://${hostname}.${{ secrets.DOMAIN }}" class="tile" target="_blank">
      <div class="tile-icon">${icon}</div>
      <div class="tile-name">${display_name}</div>
    </a>
TILE
              fi
            done

            # Close HTML
            cat >> config/dashboard/index.html << 'DASHBOARD_END'
  </div>
  <p class="footer">Auto-generated on deploy</p>
</body>
</html>
DASHBOARD_END
            echo "âœ… Dashboard generated with $(ls apps/*/ingress.yml 2>/dev/null | wc -l) apps"

            # 7. Run init scripts for each app (first-time setup)
            for init_script in apps/*/init.sh; do
              if [ -f "$init_script" ]; then
                echo "ðŸ”§ Running $(dirname $init_script)/init.sh"
                bash "$init_script"
              fi
            done

            # 8. Deployment
            sysctl -w net.core.rmem_max=2500000 || true
            docker compose up -d --build --remove-orphans
            docker image prune -f
            echo "âœ… Deployment Completed!"
