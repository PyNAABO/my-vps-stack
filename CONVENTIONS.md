# Repository Conventions

This document defines the standards and conventions used throughout the my-vps-stack repository.

## Table of Contents

1. [Directory Structure](#directory-structure)
2. [App Naming Conventions](#app-naming-conventions)
3. [Docker Compose Standards](#docker-compose-standards)
4. [Documentation Standards](#documentation-standards)
5. [Environment Variables](#environment-variables)
6. [Icons and Branding](#icons-and-branding)
7. [Git Workflow](#git-workflow)
8. [Security Guidelines](#security-guidelines)

---

## Directory Structure

```
my-vps-stack/
‚îú‚îÄ‚îÄ apps/                      # Application containers
‚îÇ   ‚îú‚îÄ‚îÄ .template/             # Template for creating new apps
‚îÇ   ‚îú‚îÄ‚îÄ .archive/              # Disabled/archived apps
‚îÇ   ‚îú‚îÄ‚îÄ <app-name>/            # Individual app folders
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml # Required: Service definition
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ingress.yml        # Optional: Cloudflare Tunnel routing
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ init.sh            # Optional: First-time setup
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ README.md          # Required: App documentation
‚îú‚îÄ‚îÄ config/                    # Configuration files
‚îú‚îÄ‚îÄ docs/                      # Additional documentation
‚îú‚îÄ‚îÄ scripts/                   # Utility scripts
‚îî‚îÄ‚îÄ .github/workflows/         # CI/CD workflows
```

### Shared Data Directory

All apps use a shared data directory structure:

```
/root/
‚îú‚îÄ‚îÄ my-vps-stack/          # This repository
‚îî‚îÄ‚îÄ vps-data/              # Shared persistent data
    ‚îî‚îÄ‚îÄ downloads/         # qBittorrent downloads
```

**Rules:**
- Use `../vps-data/` for shared data (relative to the repository)
- Use `1000:1000` ownership for all data directories
- Never commit data or config directories to git

---

## App Naming Conventions

### Folder Names

- Use **lowercase** with **hyphens** for multi-word names
- Be descriptive but concise
- Examples:
  - ‚úÖ `filebrowser`
  - ‚úÖ `uptime-kuma`
  - ‚ùå `FileBrowser` (no uppercase)
  - ‚ùå `uptime_kuma` (use hyphens, not underscores)

### Service Names

- Match the folder name in `docker-compose.yml`
- Use descriptive names for multi-container apps
- Example:
  ```yaml
  services:
    uptime-kuma:
      image: louislam/uptime-kuma:latest
  ```

---

## Docker Compose Standards

### Required Fields

Every `docker-compose.yml` must include:

```yaml
services:
  <app-name>:
    image: <image>:<tag>
    container_name: <app-name>
    restart: always
```

### Security Best Practices

```yaml
services:
  myapp:
    image: myapp:latest
    container_name: myapp
    restart: always
    security_opt:
      - no-new-privileges:true
    # Run as non-root when possible
    user: "1000:1000"
```

### Volume Mounts

**For app-specific data:**
```yaml
volumes:
  - ./data:/app/data  # Relative to app folder
```

**For shared data:**
```yaml
volumes:
  - ../vps-data/downloads:/downloads  # Relative to repo root
```

### Environment Variables

Reference variables from `.env` (auto-generated by CI/CD):

```yaml
environment:
  - DOMAIN_NAME=${DOMAIN_NAME}
  - TG_BOT_TOKEN=${TG_BOT_TOKEN}
```

---

## Documentation Standards

### App README.md Template

Every app must have a `README.md` with these sections:

```markdown
# App Name

**Brief description**

One-line description of what this app does.

## üöÄ Usage

- **URL:** `https://<subdomain>.yourdomain.com`
- **Credentials:** Description of how to access (e.g., "Check docker logs")

## üìÅ Volumes

| Host Path | Container Path | Description |
| :-------- | :------------- | :---------- |
| `./data` | `/app/data` | App configuration |
| `../vps-data` | `/srv` | Shared data directory |

## ‚öôÔ∏è Configuration

Key configuration details.

## üêõ Troubleshooting

Common issues and solutions.
```

### Required Sections

1. **Title** - App name with emoji
2. **Description** - One-line summary
3. **Usage** - URL and access information
4. **Volumes** - Table of mounted volumes
5. **Configuration** - Setup details
6. **Troubleshooting** - Common issues (if applicable)

### Optional Sections

- **Features** - Key features list
- **How It Works** - Technical explanation
- **Security Notes** - Security-related information

---

## Environment Variables

### Standard Variables

These are automatically injected by the CI/CD pipeline:

| Variable | Description | Source |
| :------- | :---------- | :------- |
| `DOMAIN_NAME` | Your domain name | GitHub Secret: `DOMAIN` |
| `TG_BOT_TOKEN` | Telegram bot token | GitHub Secret: `TG_BOT_TOKEN` |
| `ALLOWED_GROUP_ID` | Allowed Telegram group | GitHub Secret: `ALLOWED_GROUP_ID` |

### Adding New Variables

1. Add to GitHub Secrets (Settings ‚Üí Secrets and variables ‚Üí Actions)
2. Export in `.github/workflows/deploy.yml` Step 5
3. Use in your app's `docker-compose.yml`

---

## Icons and Branding

### Dashboard Icons

All web-accessible apps should have an icon in `apps/dashboard/icons.conf`:

```
# Format: app_name=fa-<style> fa-<icon-name>
portainer=fa-solid fa-box-open
filebrowser=fa-solid fa-folder-open
```

**Icon Sources:**
- [FontAwesome Free Icons](https://fontawesome.com/search)
- Use `fa-solid` for most icons
- Use `fa-brands` for brand logos (e.g., Telegram, WhatsApp)

### Default Icon

Unknown apps use: `__default__=fa-solid fa-link`

---

## Git Workflow

### Branches

- `main` - Production-ready code
- `feature/<name>` - New features
- `fix/<name>` - Bug fixes

### Commits

Use descriptive commit messages:

```
feat: Add new app (app-name)
fix: Correct volume path in app-name
docs: Update README with troubleshooting info
refactor: Move app to archive
```

### Pre-commit Checklist

Before committing:

1. [ ] App has `README.md` with all required sections
2. [ ] `docker-compose.yml` is valid YAML
3. [ ] Port numbers don't conflict with existing apps
4. [ ] Icon added to `icons.conf` (if web-accessible)
5. [ ] `init.sh` has executable permissions (if present)
6. [ ] No hardcoded secrets in any files
7. [ ] No absolute paths that won't work on other systems

---

## Security Guidelines

### Never Commit

- ‚ùå Secrets or API keys
- ‚ùå SSH private keys
- ‚ùå Cloudflare tunnel credentials
- ‚ùå Database passwords
- ‚ùå Configuration files with sensitive data

### Always Use

- ‚úÖ GitHub Secrets for sensitive data
- ‚úÖ `.env` file for local development (gitignored)
- ‚úÖ `1000:1000` ownership for data directories
- ‚úÖ `no-new-privileges:true` security option
- ‚úÖ Non-root users in containers when possible

### Cloudflare Access

All web services should be protected by Cloudflare Access:

1. Create Service Token in Cloudflare Zero Trust
2. Add to GitHub Secrets: `CF_CLIENT_ID`, `CF_CLIENT_SECRET`
3. Configure Access policies in Cloudflare dashboard

---

## Adding a New App

Follow this checklist when adding a new app:

1. **Create folder** in `apps/<app-name>/`
2. **Add `docker-compose.yml`** with proper configuration
3. **Add `ingress.yml`** (if web-accessible)
4. **Add `init.sh`** (if initialization needed)
5. **Add `README.md`** following the template above
6. **Add icon** to `apps/dashboard/icons.conf`
7. **Update main README.md** (if making the app active)
8. **Test locally** before pushing

---

## Archive Process

To archive an app (disable but keep files):

1. Move folder from `apps/<app-name>/` to `apps/.archive/<app-name>/`
2. Remove icon from `apps/dashboard/icons.conf` Core Apps section
3. Add icon to Archived Apps section in `icons.conf`
4. Update main `README.md` to move app from active to archived list
5. Commit with message: `refactor: Archive app-name`

To re-enable, reverse the process.

---

## Questions?

If you're unsure about any convention, check existing apps for examples or ask in the project discussions.
