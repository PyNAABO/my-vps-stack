# Cloudflare Tunnel

**Secure Tunneling Daemon**

Exposes your private services to the internet without opening ports.

## üöÄ Usage

- **Status:** Runs in background. Check logs via `docker logs`.
- **Command:** `cloudflared tunnel run`

## ‚öôÔ∏è Configuration

- **Config:** `config/tunnel/config.yml` (Auto-generated by deploy workflow).
- **Credentials:** `config/tunnel/cert.json` (Injected from GitHub Secrets).

## üîê How It Works

The Cloudflare Tunnel creates an outbound-only connection to Cloudflare's network, allowing:
- **No open ports** - Only port 22 (SSH) needs to be open on your VPS
- **Automatic HTTPS** - All services get HTTPS certificates automatically
- **Custom subdomains** - Each service gets its own subdomain (e.g., `home.yourdomain.com`)

## üìù Setup Process

### Prerequisites

1. A domain managed by Cloudflare
2. A Cloudflare account

### Initial Setup

1. **Install cloudflared** on your VPS:
   ```bash
   wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O /usr/local/bin/cloudflared
   chmod +x /usr/local/bin/cloudflared
   ```

2. **Authenticate** with Cloudflare:
   ```bash
   cloudflared tunnel login
   # This opens a browser - copy the URL if running headless
   ```

3. **Create a tunnel**:
   ```bash
   cloudflared tunnel create vps-stack
   # Note the Tunnel ID (UUID) - you'll need this
   ```

4. **Create a wildcard DNS record**:
   - In Cloudflare dashboard, go to DNS ‚Üí Add Record
   - Type: CNAME
   - Name: `*`
   - Target: `<TUNNEL_UUID>.cfargotunnel.com`
   - TTL: Auto

### GitHub Secrets

Add these to your repository (Settings ‚Üí Secrets and variables ‚Üí Actions):

| Secret | Description | How to Get |
|--------|-------------|------------|
| `TUNNEL_ID` | Your tunnel UUID | From `cloudflared tunnel list` |
| `TUNNEL_CREDENTIALS` | Tunnel credentials JSON | Copy from `~/.cloudflared/<UUID>.json` |
| `CF_CLIENT_ID` | Cloudflare Access Service Token ID | Create in Cloudflare Zero Trust |
| `CF_CLIENT_SECRET` | Cloudflare Access Service Token Secret | Create in Cloudflare Zero Trust |

### Service Routing

Services are automatically routed based on their `ingress.yml` files:

```yaml
# Example: apps/dashboard/ingress.yml
hostname: home    # becomes home.yourdomain.com
service: http://dashboard:8090
```

The deploy workflow automatically:
1. Collects all `ingress.yml` files
2. Generates `config/tunnel/config.yml`
3. Restarts the tunnel to apply changes

## üêõ Troubleshooting

### Tunnel won't connect

```bash
# Check tunnel status
cloudflared tunnel info <TUNNEL_ID>

# View tunnel logs
docker logs cloudflare-tunnel

# Verify credentials exist
ls -la config/tunnel/cert.json
```

### Service not accessible

1. **Check ingress configuration:**
   ```bash
   cat config/tunnel/config.yml
   ```

2. **Verify the service is running:**
   ```bash
   docker ps | grep <service-name>
   ```

3. **Test the service locally:**
   ```bash
   curl http://localhost:<port>
   ```

### Authentication issues (Cloudflare Access)

- Ensure `CF_CLIENT_ID` and `CF_CLIENT_SECRET` are correct
- Verify the Service Token has access to your applications in Cloudflare Zero Trust
- Check Cloudflare Access logs in the Zero Trust dashboard

## üìö Resources

- [Cloudflare Tunnel Docs](https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/)
- [Cloudflare Access Docs](https://developers.cloudflare.com/cloudflare-one/policies/access/)
